name: Testes Multi-SO

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    name: Testar em ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11']
        include:
          - os: ubuntu-latest
            python-version: '3.8'
          - os: windows-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.8'

    steps:
      # CORRE√á√ÉO: Remove shell do checkout (n√£o precisa)
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          else
            echo "‚úÖ Sem requirements.txt"
          fi
        shell: bash  # Mant√©m aqui (tem run)

      - name: Executar testes
        env:
          PYTHONIOENCODING: utf-8
          PYTHONUTF8: 1
        run: |
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          python -m unittest discover -v tests/
        shell: bash  # Mant√©m aqui (tem run)

      - name: Gerar relat√≥rio
        env:
          PYTHONIOENCODING: utf-8
          PYTHONUTF8: 1
        run: |
          echo "üìä Gerando relat√≥rio para ${{ matrix.os }}"

          python -c "
          import sys
          import platform
          import json
          import os
          from pathlib import Path

          print(f'üêç Python {sys.version}')
          print(f'üìÇ Working dir: {os.getcwd()}')

          sys.path.insert(0, '.')
          from src.sistema_info import SistemaInfo

          info = SistemaInfo.get_info_completa()
          sistema = platform.system()

          output_dir = Path(os.environ.get('GITHUB_WORKSPACE', '.'))
          print(f'üìÅ Output dir: {output_dir}')

          relatorio = {
              'sistema': sistema,
              'info': info,
              'status': 'PASSOU' if info['sistema'] == sistema else 'FALHOU'
          }

          filename = output_dir / f'relatorio_{sistema}.json'
          with open(filename, 'w', encoding='utf-8') as f:
              json.dump(relatorio, f, indent=2, ensure_ascii=False)

          print(f'‚úÖ Relat√≥rio salvo: {filename}')
          print(f'üìä Tamanho: {filename.stat().st_size} bytes')
          "

                    echo "üîç Verificando arquivos gerados:"
                    ls -la $GITHUB_WORKSPACE/relatorio_*.json || echo "‚ö†Ô∏è Nenhum relat√≥rio encontrado"
                  shell: bash  # Mant√©m aqui (tem run)

                - name: Upload relat√≥rio
                  uses: actions/upload-artifact@v4
                  with:
                    name: relatorio-${{ matrix.os }}-py${{ matrix.python-version }}
                    path: ${{ github.workspace }}/relatorio_*.json
                    if-no-files-found: warn
                    retention-days: 7
                  # CORRE√á√ÉO: Remove shell daqui (n√£o tem run, √© uma action)