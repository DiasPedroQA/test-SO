name: Testes Multi-SO

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    name: Testar em ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11']
        include:
          - os: ubuntu-latest
            python-version: '3.8'
          - os: windows-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.8'
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ Configurar Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        shell: bash
      
      - name: ğŸ” InformaÃ§Ãµes do ambiente
        run: |
          echo "ğŸ¯ Sistema: ${{ matrix.os }}"
          echo "ğŸ Python: ${{ matrix.python-version }}"
          echo "ğŸ“‚ DiretÃ³rio: $(pwd)"
          echo "ğŸ“‹ ConteÃºdo do src/:"
          ls -la src/ || echo "src/ nÃ£o encontrado"
        shell: bash
      
      - name: ğŸ§ª Executar testes unitÃ¡rios
        env:
          PYTHONIOENCODING: utf-8
          PYTHONUTF8: 1
        run: |
          echo "==================================="
          echo "ğŸ§ª TESTANDO EM ${{ matrix.os }}"
          echo "==================================="
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          python -m unittest discover -v tests/
        shell: bash
      
      - name: ğŸ“Š Gerar relatÃ³rio com a classe correta
        env:
          PYTHONIOENCODING: utf-8
          PYTHONUTF8: 1
        run: |
          echo "==================================="
          echo "ğŸ“Š RELATÃ“RIO DO SISTEMA"
          echo "==================================="

          python -c "
          import sys
          import platform
          import json
          from pathlib import Path

          # Adiciona o diretÃ³rio atual ao path
          sys.path.insert(0, '.')
          from src.sistema_info import SistemaInfo

          # ObtÃ©m informaÃ§Ãµes usando a classe correta
          info = SistemaInfo.get_info_completa()
          sistema_atual = platform.system()

          # Mapeia as informaÃ§Ãµes para exibiÃ§Ã£o
          print(f'\nğŸ” SISTEMA DETECTADO: {info[\"sistema\"]}')
          print(f'ğŸ“Œ VersÃ£o: {info[\"sistema_versao\"]}')
          print(f'ğŸ’» Arquitetura: {info[\"arquitetura\"]}')
          print(f'ğŸ  Home path: {info[\"home_path\"]}')
          print(f'âœ… Home vÃ¡lida: {SistemaInfo.validar_home_path()}')

          # InformaÃ§Ãµes especÃ­ficas por SO
          if 'distribuicao' in info:
              print(f'ğŸ§ DistribuiÃ§Ã£o Linux: {info[\"distribuicao\"]}')
          if 'versao_macos' in info:
              print(f'ğŸ VersÃ£o macOS: {info[\"versao_macos\"]}')
          if 'variaveis_windows' in info:
              print(f'ğŸªŸ VariÃ¡veis Windows encontradas')

          # ValidaÃ§Ã£o
          if info['sistema'] == sistema_atual:
              print(f'\nâœ… VALIDAÃ‡ÃƒO: Sistema correto!')
          else:
              print(f'\nâŒ VALIDAÃ‡ÃƒO: Sistema incorreto!')

          # Salva relatÃ³rio
          relatorio = {
              'sistema': sistema_atual,
              'info': info,
              'status': 'PASSOU' if info['sistema'] == sistema_atual else 'FALHOU'
          }

          filename = f'relatorio_{sistema_atual}.json'
          with open(filename, 'w', encoding='utf-8') as f:
              json.dump(relatorio, f, indent=2, ensure_ascii=False)
          print(f'\nğŸ“Š RelatÃ³rio salvo: {filename}')
          "
        shell: bash
      
      - name: âœ… Validar saÃ­da esperada
        env:
          PYTHONIOENCODING: utf-8
          PYTHONUTF8: 1
        run: |
          python -c "
          import sys
          import platform
          sys.path.insert(0, '.')
          from src.sistema_info import SistemaInfo

          info = SistemaInfo.get_info_completa()
          sistema_real = platform.system()

          assert info['sistema'] == sistema_real, f'Sistema incorreto: {info[\"sistema\"]} != {sistema_real}'
          print('âœ… ValidaÃ§Ã£o bÃ¡sica passou!')
          "
        shell: bash
      
      - name: ğŸ“¤ Upload do relatÃ³rio
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-${{ matrix.os }}-py${{ matrix.python-version }}
          path: relatorio_*.json

  summary:
    name: ğŸ“‹ Resumo dos testes
    needs: test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“¥ Download todos os relatÃ³rios
        uses: actions/download-artifact@v4
        with:
          path: relatorios
      
      - name: ğŸ“Š Exibir resumo
        run: |
          echo "==================================="
          echo "ğŸ“‹ RESUMO FINAL DOS TESTES"
          echo "==================================="
          echo "âœ… Pipeline executada com sucesso!"
          echo ""
          echo "ğŸ“Š Resultados por SO:"
          echo "  â€¢ Ubuntu (3.8, 3.11)"
          echo "  â€¢ Windows (3.8, 3.11)"
          echo "  â€¢ macOS (3.8, 3.11)"
          echo ""
          echo "ğŸ“ RelatÃ³rios disponÃ­veis nos artifacts"
        shell: bash