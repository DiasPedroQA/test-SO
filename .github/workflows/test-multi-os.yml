name: Testes Multi-SO

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    name: Testar em ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11']
        include:
          - os: ubuntu-latest
            python-version: '3.8'
          - os: windows-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.8'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      # CORRIGIDO: Usa Python em vez de Bash
      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          python -c "import os; os.system('pip install -r requirements.txt') if os.path.exists('requirements.txt') else print('‚úÖ Sem requirements.txt')"
      
      # CORRIGIDO: Usa sintaxe compat√≠vel com Windows
      - name: Executar testes
        env:
          PYTHONIOENCODING: utf-8
          PYTHONUTF8: 1
        run: |
          # Configura PYTHONPATH de forma compat√≠vel com Windows
          $env:PYTHONPATH = "$env:PYTHONPATH;$pwd"
          python -m unittest discover -v tests/
        shell: pwsh
      
      # CORRIGIDO: Usa Python para listar arquivos (compat√≠vel com Windows)
      - name: Gerar relat√≥rio
        env:
          PYTHONIOENCODING: utf-8
          PYTHONUTF8: 1
        run: |
          echo "üìä Gerando relat√≥rio para ${{ matrix.os }}"
          
          python -c "
          import sys
          import platform
          import json
          import os
          from pathlib import Path
          
          print(f'üêç Python {sys.version}')
          print(f'üìÇ Working dir: {os.getcwd()}')
          
          sys.path.insert(0, '.')
          from src.sistema_info import SistemaInfo
          
          info = SistemaInfo.get_info_completa()
          sistema = platform.system()
          
          output_dir = Path(os.environ.get('GITHUB_WORKSPACE', '.'))
          print(f'üìÅ Output dir: {output_dir}')
          
          relatorio = {
              'sistema': sistema,
              'info': info,
              'status': 'PASSOU'
          }
          
          filename = output_dir / f'relatorio_{sistema}.json'
          with open(filename, 'w', encoding='utf-8') as f:
              json.dump(relatorio, f, indent=4, ensure_ascii=False)
          
          print(f'‚úÖ Relat√≥rio salvo: {filename}')
          print(f'üìä Tamanho: {filename.stat().st_size} bytes')
          
          # Lista arquivos usando Python (compat√≠vel com Windows)
          print('\nüîç Arquivos encontrados:')
          for file in output_dir.glob('relatorio_*.json'):
              print(f'  - {file.name} ({file.stat().st_size} bytes)'
          "
                    
                    # Verifica√ß√£o final usando Python (n√£o 'ls')
                    python -c "
          import os
          from pathlib import Path
          output_dir = Path(os.environ.get('GITHUB_WORKSPACE', '.'))
          files = list(output_dir.glob('relatorio_*.json'))
          if files:
              print(f'‚úÖ {len(files)} relat√≥rio(s) encontrado(s)')
          else:
              print('‚ö†Ô∏è Nenhum relat√≥rio encontrado')
              exit(1)
          "
      
      - name: Upload relat√≥rio
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-${{ matrix.os }}-py${{ matrix.python-version }}
          path: ${{ github.workspace }}/relatorio_*.json
          if-no-files-found: warn
          retention-days: 7