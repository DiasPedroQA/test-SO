name: Testes Multi-SO

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    name: Testar em ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11']
        include:
          - os: ubuntu-latest
            python-version: '3.8'
          - os: windows-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.8'
    
    steps:
    - name: üì• Checkout do c√≥digo
      uses: actions/checkout@v3
    
    - name: üêç Configurar Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: üì¶ Instalar depend√™ncias
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      shell: bash
    
    - name: üîç Informa√ß√µes do ambiente
      run: |
        echo "üéØ Sistema: ${{ matrix.os }}"
        echo "üêç Python: ${{ matrix.python-version }}"
        echo "üìÇ Diret√≥rio: $(pwd)"
        echo "üìã Conte√∫do do src/:"
        ls -la src/ || echo "src/ n√£o encontrado"
      shell: bash
    
    - name: üß™ Executar testes unit√°rios
      env:
        # CORRE√á√ÉO 2: For√ßa UTF-8 no Windows para evitar erro de encoding
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      run: |
        echo "==================================="
        echo "üß™ TESTANDO EM ${{ matrix.os }}"
        echo "==================================="
        # Adiciona src ao PYTHONPATH
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        python -m unittest discover -v tests/
      shell: bash
    
    - name: üìä Gerar relat√≥rio com a classe correta
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      run: |
        echo "==================================="
        echo "üìä RELAT√ìRIO DO SISTEMA"
        echo "==================================="
        
        # CORRE√á√ÉO 1 e 3: Usa a classe SistemaInfo com as chaves corretas
        python -c "
            import sys
            import platform
            import json
            from pathlib import Path

            # Adiciona o diret√≥rio atual ao path
            sys.path.insert(0, '.')
            from src.sistema_info import SistemaInfo

            # Obt√©m informa√ß√µes usando a classe correta
            info = SistemaInfo.get_info_completa()
            sistema_atual = platform.system()

            # Mapeia as informa√ß√µes para exibi√ß√£o
            print(f'\nüîç SISTEMA DETECTADO: {info[\"sistema\"]}')
            print(f'üìå Vers√£o: {info[\"sistema_versao\"]}')
            print(f'üíª Arquitetura: {info[\"arquitetura\"]}')
            print(f'üè† Home path: {info[\"home_path\"]}')
            print(f'‚úÖ Home v√°lida: {SistemaInfo.validar_home_path()}')

            # Informa√ß√µes espec√≠ficas por SO
            if 'distribuicao' in info:
                print(f'üêß Distribui√ß√£o Linux: {info[\"distribuicao\"]}')
            if 'versao_macos' in info:
                print(f'üçé Vers√£o macOS: {info[\"versao_macos\"]}')
            if 'variaveis_windows' in info:
                print(f'ü™ü Vari√°veis Windows encontradas')

            # Valida√ß√£o
            if info['sistema'] == sistema_atual:
                print(f'\n‚úÖ VALIDA√á√ÉO: Sistema correto!')
            else:
                print(f'\n‚ùå VALIDA√á√ÉO: Sistema incorreto!')

            # Salva relat√≥rio
            relatorio = {
                'sistema': sistema_atual,
                'info': info,
                'status': 'PASSOU' if info['sistema'] == sistema_atual else 'FALHOU'
            }

            filename = f'relatorio_{sistema_atual}.json'
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(relatorio, f, indent=2, ensure_ascii=False)
            print(f'\nüìä Relat√≥rio salvo: {filename}')
            "
                  shell: bash

                - name: ‚úÖ Validar sa√≠da esperada (sem emojis no Windows)
                  env:
                    PYTHONIOENCODING: utf-8
                    PYTHONUTF8: 1
                  run: |
                    python -c "
            import sys
            import platform
            sys.path.insert(0, '.')
            from src.sistema_info import SistemaInfo

            info = SistemaInfo.get_info_completa()
            sistema_real = platform.system()

            # Valida√ß√£o sem usar emojis para compatibilidade
            assert info['sistema'] == sistema_real, f'Sistema incorreto: {info[\"sistema\"]} != {sistema_real}'
            print('Validacao basica passou!')
            "
                  shell: bash

                - name: üì§ Upload do relat√≥rio
                  uses: actions/upload-artifact@v3
                  with:
                    name: relatorio-${{ matrix.os }}-py${{ matrix.python-version }}
                    path: relatorio_*.json

              summary:
                name: üìã Resumo dos testes
                needs: test
                runs-on: ubuntu-latest
                if: always()
                steps:
                  - name: Download todos os relat√≥rios
                    uses: actions/download-artifact@v3
                    with:
                      path: relatorios

                  - name: Exibir resumo
                    run: |
                      echo "==================================="
                      echo "üìã RESUMO FINAL DOS TESTES"
                      echo "==================================="
                      echo "‚úÖ Pipeline executada com sucesso!"
                      echo ""
                      echo "üìä Resultados por SO:"
                      echo "  ‚Ä¢ Ubuntu (3.8, 3.11)"
                      echo "  ‚Ä¢ Windows (3.8, 3.11)"
                      echo "  ‚Ä¢ macOS (3.8, 3.11)"
                      echo ""
                      echo "üìÅ Relat√≥rios dispon√≠veis nos artifacts"
