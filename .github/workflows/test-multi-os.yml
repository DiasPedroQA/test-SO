name: Testes Multi-SO

# Quando executar
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  # Permite executar manualmente
  workflow_dispatch:

jobs:
  test:
    name: Testar em ${{ matrix.os }}
    # EstratÃ©gia de matriz: roda em paralelo em vÃ¡rios SOs
    runs-on: ${{ matrix.os }}
    strategy:
      # NÃ£o cancela outros se um falhar
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11']
        # Teste adicional: versÃ£o mÃ­nima vs mÃ¡xima
        include:
          - os: ubuntu-latest
            python-version: '3.8'
          - os: windows-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.8'
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v3
    
    - name: ğŸ Configurar Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        # Se tiver requirements.txt
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        # Instala pytest para relatÃ³rios melhores
        pip install pytest pytest-cov
      shell: bash
    
    - name: ğŸ” InformaÃ§Ãµes do ambiente
      run: |
        echo "ğŸ¯ Sistema: ${{ matrix.os }}"
        echo "ğŸ Python: ${{ matrix.python-version }}"
        echo "ğŸ“‚ DiretÃ³rio: $(pwd)"
        echo "ğŸ“‹ ConteÃºdo:"
        ls -la
      shell: bash
    
    - name: ğŸ§ª Executar testes unitÃ¡rios
      run: |
        echo "==================================="
        echo "ğŸ§ª TESTANDO EM ${{ matrix.os }}"
        echo "==================================="
        python -m unittest discover -v tests/
      shell: bash
      continue-on-error: false
    
    - name: ğŸ“Š Gerar relatÃ³rio detalhado
      run: |
        echo "==================================="
        echo "ğŸ“Š RESULTADO POR SO"
        echo "==================================="
        
        # Executa cada teste e captura saÃ­da
        python -c "
        import sys
        sys.path.insert(0, '.')
        from src.sistema_info import identificar_sistema
        info = identificar_sistema()
        print(f'Sistema detectado: {info[\"sistema\"]}')
        print(f'Detalhes: {info[\"detalhes\"]}')
        print(f'Home: {info[\"home\"]}')
        print(f'Arquitetura: {info[\"arquitetura\"]}')
        print(f'UsuÃ¡rio: {info[\"usuario\"]}')
        "
              shell: bash

            - name: âœ… Validar saÃ­da esperada
              run: |
                python -c "
        import sys
        import platform
        sys.path.insert(0, '.')
        from src.sistema_info import identificar_sistema
        info = identificar_sistema()
        sistema_real = platform.system()
        assert info['sistema'] == sistema_real, f'Sistema incorreto: {info[\"sistema\"]} != {sistema_real}'
        print('âœ… ValidaÃ§Ã£o bÃ¡sica passou!')
        "
              shell: bash

            - name: âš ï¸ Upload de logs em caso de falha
              if: failure()
              uses: actions/upload-artifact@v3
              with:
                name: test-logs-${{ matrix.os }}-${{ matrix.python-version }}
                path: |
                  *.log
                  test-results.xml

          # Job de resumo
          summary:
            name: ğŸ“‹ Resumo dos testes
            needs: test
            runs-on: ubuntu-latest
            if: always()
            steps:
              - name: Verificar resultados
                run: |
                  echo "==================================="
                  echo "ğŸ“‹ RESUMO FINAL DOS TESTES"
                  echo "==================================="
                  echo "âœ… Todos os jobs foram executados"
                  echo "ğŸ“Š Matrix testada:"
                  echo "  â€¢ Ubuntu (3.8, 3.9, 3.10, 3.11)"
                  echo "  â€¢ Windows (3.8, 3.9, 3.10, 3.11)"
                  echo "  â€¢ macOS (3.8, 3.9, 3.10, 3.11)"
                  echo ""
                  echo "ğŸ” Verifique os resultados individuais acima"
